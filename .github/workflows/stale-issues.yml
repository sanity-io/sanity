name: Close Stale Issues Needing More Info

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  pull_request:
    paths:
      - ".github/workflows/stale-issues.yml"

permissions:
  issues: write
  pull-requests: read

concurrency:
  group: stale-issues
  cancel-in-progress: false

jobs:
  stale:
    runs-on: ubuntu-latest
    steps:
      - name: Mark and close stale issues
        uses: actions/stale@v10
        with:
          # Enable detailed statistics in logs
          enable-statistics: true

          # Target only issues with "needs-more-info" label
          only-issue-labels: "needs-more-info"

          # Only process issues created/labeled after this date (prevents backlog processing)
          start-date: "2026-01-29T00:00:00Z"

          # Timing: 10 days warning + 4 days to close = 14 days total
          days-before-stale: 10
          days-before-close: 4

          # Reuse existing label (no additional stale label needed)
          stale-issue-label: "needs-more-info"

          # Warning message (posted after 10 days)
          stale-issue-message: >
            Hi there, thanks again for this issue report. We have had a look into it
            and are currently waiting for some more information. If you are able to help by
            providing any further details as requested above that would be a great help.
            If you are no longer experiencing this issue, or aren't able to provide any
            further details, this issue will be closed in another 4 days.

          # Closure message (posted after 14 days total)
          close-issue-message: >
            Hi there, we really appreciate your report of this issue. We had been
            waiting for some more details to look into this properly. Since we didn't hear
            back, we are going to close this issue at this current time. However, please
            do either reopen or raise another issue if you find this is still causing concern.
            We really thank you for the time to help us make Studio a better experience for
            all users!

          # Don't process pull requests
          days-before-pr-stale: -1
          days-before-pr-close: -1

          # Process up to 30 issues per run (default, prevents rate limiting)
          operations-per-run: 30

          # Remove needs-more-info label if issue gets new activity after warning
          remove-stale-when-updated: true

      - name: Report actions taken
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_BASE_URL: ${{ github.server_url }}/${{ github.repository }}/issues
        run: |
          # Time window for detecting recent changes (5 minutes in seconds)
          TIME_WINDOW=300

          # Helper function to write a section to the GitHub step summary
          write_section() {
            local title="$1"
            local content="$2"
            local empty_message="$3"

            echo "### ${title}" >> "$GITHUB_STEP_SUMMARY"
            if [ -z "$content" ]; then
              echo "$empty_message" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "$content" >> "$GITHUB_STEP_SUMMARY"
            fi
            echo "" >> "$GITHUB_STEP_SUMMARY"
          }

          # Helper function to format issues as markdown links
          format_as_markdown_links() {
            jq -r --arg base_url "$ISSUE_BASE_URL" \
              '.[] | "- [#\(.number)](\($base_url)/\(.number)) - \(.title)"'
          }

          # Write summary header
          {
            echo "## Stale Issue Workflow Summary"
            echo ""
            echo "**Workflow completed at:** $(date -u)"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          # Find issues that received stale warnings in this run
          # Criteria: open issues with "needs-more-info" label where the last comment
          # was posted by github-actions within the time window and contains the warning text
          WARNING_ISSUES=$(
            gh issue list \
              --label "needs-more-info" \
              --state open \
              --limit 100 \
              --json number,title,comments,updatedAt \
            | jq --argjson time_window "$TIME_WINDOW" '
                [.[] | select(
                  .comments[-1].author.login == "github-actions" and
                  (.comments[-1].body | contains("will be closed in another 4 days")) and
                  (.updatedAt | fromdateiso8601) > (now - $time_window)
                )]
              ' \
            | format_as_markdown_links 2>/dev/null || echo ""
          )

          write_section \
            "Warning of Closure (10 days inactive)" \
            "$WARNING_ISSUES" \
            "No issues received warnings in this run."

          # Find issues that were closed by the stale action in this run
          # Criteria: closed issues with "needs-more-info" label that were
          # closed within the time window
          CLOSED_ISSUES=$(
            gh issue list \
              --label "needs-more-info" \
              --state closed \
              --limit 100 \
              --json number,title,closedAt \
            | jq --argjson time_window "$TIME_WINDOW" '
                [.[] | select(
                  (.closedAt | fromdateiso8601) > (now - $time_window)
                )]
              ' \
            | format_as_markdown_links 2>/dev/null || echo ""
          )

          write_section \
            "Closed (14 days inactive)" \
            "$CLOSED_ISSUES" \
            "No issues were closed in this run."

          # Write footer
          {
            echo "---"
            echo "*Check the workflow logs above for detailed statistics.*"
          } >> "$GITHUB_STEP_SUMMARY"
